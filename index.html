// netlify/functions/checkin.js
const WEBAPP_URL =
  "https://script.google.com/macros/s/AKfycbznzmdsNzjEpqCUoy0KcOKkTunU_RDJClTAKRd8xjFN1iTpAWQR-BRTHgdTwtmgV93Z/exec";

function json(statusCode, obj) {
  return {
    statusCode,
    headers: {
      "Content-Type": "application/json; charset=utf-8",
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Headers": "Content-Type",
      "Access-Control-Allow-Methods": "GET,POST,OPTIONS",
    },
    body: JSON.stringify(obj),
  };
}

function html(statusCode, body) {
  return {
    statusCode,
    headers: {
      "Content-Type": "text/html; charset=utf-8",
      "Access-Control-Allow-Origin": "*",
    },
    body,
  };
}

exports.handler = async (event) => {
  try {
    // CORS preflight
    if (event.httpMethod === "OPTIONS") {
      return json(200, { ok: true, preflight: true });
    }

    const qs = event.queryStringParameters || {};
    const id = String(qs.id || qs.ID || "").trim();

    // ---------- GET: mostrar página (QR abre esto) ----------
    if (event.httpMethod === "GET") {
      if (!id) {
        return html(
          400,
          `<h2>❌ Falta id</h2><p>El QR debe tener ?id=FLS_0000...</p>`
        );
      }

      // Esta página solo sirve como "entrada". Tu frontend real puede ser otro.
      return html(
        200,
        `
<!doctype html>
<html>
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Check-in</title></head>
<body style="font-family:Arial,sans-serif;padding:16px">
  <h2>Check-in Flor de Lis</h2>
  <p><b>ID:</b> ${id}</p>
  <p>✅ El link está bien. Ahora usa el formulario de tu web para enviar firma y cédula.</p>
  <p style="color:#666;font-size:12px">Si sigues viendo “no devolvió JSON”, el problema está en el POST.</p>
</body>
</html>`
      );
    }

    // ---------- POST: reenviar a Apps Script ----------
    if (event.httpMethod === "POST") {
      let payload = {};
      try {
        payload = JSON.parse(event.body || "{}");
      } catch (e) {
        return json(400, { ok: false, error: "JSON inválido en Netlify", detail: e.message });
      }

      // asegura id desde querystring si no vino en body
      if (!payload.id && id) payload.id = id;

      // REENVIO a Apps Script
      const r = await fetch(WEBAPP_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const text = await r.text(); // <-- CLAVE: primero texto

      // intenta parsear JSON
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        // aquí está la razón real del “no devolvió JSON”
        return json(502, {
          ok: false,
          error: "Apps Script devolvió NO-JSON (HTML u otro).",
          http_status: r.status,
          body_preview: text.slice(0, 1500),
        });
      }

      // devuelve lo que respondió Apps Script
      return json(200, data);
    }

    return json(405, { ok: false, error: "Método no permitido" });
  } catch (err) {
    return json(500, { ok: false, error: "Error interno Netlify", detail: String(err) });
  }
};
