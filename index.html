<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Check-in Hotel</title>
  <style>
    body{font-family:Arial;max-width:540px;margin:40px auto;padding:0 16px;text-align:center}
    .card{border:1px solid #ddd;border-radius:14px;padding:18px}
    .big{font-size:20px;margin:10px 0}
    .muted{color:#666}
    code{background:#f5f5f5;padding:2px 6px;border-radius:6px}
    button{font-size:18px;padding:12px 16px;border-radius:12px;border:0;cursor:pointer}
  </style>
</head>
<body>
  <div class="card">
    <div class="big" id="status">Procesando…</div>
    <div class="muted" id="details"></div>
    <div style="margin-top:14px">
      <button onclick="location.reload()">Reintentar</button>
    </div>
  </div>

<script>
  function getParam(name){
    const p = new URLSearchParams(location.search);
    return p.get(name) || "";
  }

  async function run(){
    const id = getParam("id");
    const status = document.getElementById("status");
    const details = document.getElementById("details");

    if(!id){
      status.textContent = "Falta el parámetro id";
      details.innerHTML = 'Ejemplo: <code>?id=FLS_0000343</code>';
      return;
    }

    try{
      const r = await fetch("/.netlify/functions/checkin?id=" + encodeURIComponent(id));
      const data = await r.json();

      status.textContent = data.message || "Respuesta sin mensaje";
      if(data.cliente || data.suite){
        details.textContent = `Cliente: ${data.cliente || "-"} | Suite: ${data.suite || "-"}`;
      } else {
        details.textContent = "";
      }
    }catch(e){
      status.textContent = "Error al conectar";
      details.textContent = String(e);
    }
  }

  run();
</script>
</body>

</html>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxCDnKVgsE7Snphmqa1-i1GpOKMTxdcF34dfWJhnS4L5fYyFrQMwclrxWIq2V00pBhg/exec";

// 1) Tomar el ID desde la URL: ?id=FLS_0000347
function getIdFromUrl() {
  const params = new URLSearchParams(window.location.search);
  return (params.get("id") || "").trim();
}

// 2) Convertir un archivo (input type=file) a DataURL (base64)
function fileToDataUrl(file) {
  return new Promise((resolve, reject) => {
    if (!file) return resolve("");
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);     // DataURL completo
    reader.onerror = () => reject(new Error("No se pudo leer el archivo"));
    reader.readAsDataURL(file);
  });
}

// 3) Tomar firma del canvas a DataURL
function getFirmaDataUrl() {
  const canvas = document.getElementById("firmaCanvas");
  if (!canvas) return "";
  return canvas.toDataURL("image/png");
}

// 4) Botón Confirmar ingreso
document.getElementById("btnConfirmar")?.addEventListener("click", async () => {
  try {
    const id = getIdFromUrl();
    if (!id) {
      alert("No se encontró el ID en el enlace. Ej: ?id=FLS_0000347");
      return;
    }

    const personal = (document.getElementById("personal")?.value || "").trim();
    const pin = (document.getElementById("pin")?.value || "").trim();

    const frenteFile = document.getElementById("cedulaFrente")?.files?.[0];
    const reversoFile = document.getElementById("cedulaReverso")?.files?.[0];

    const firmaDataUrl = getFirmaDataUrl();

    if (!personal) return alert("Escribe el nombre del personal.");
    if (!pin) return alert("Escribe el PIN.");
    if (!firmaDataUrl) return alert("Falta la firma.");
    if (!frenteFile) return alert("Falta la foto de cédula (Frente).");
    if (!reversoFile) return alert("Falta la foto de cédula (Reverso).");

    // Convertir fotos a base64
    const cedulaFrenteDataUrl = await fileToDataUrl(frenteFile);
    const cedulaReversoDataUrl = await fileToDataUrl(reversoFile);

    // Armar payload EXACTO como tu Apps Script espera
    const payload = {
      id,
      personal,
      pin,
      firmaDataUrl,
      cedulaFrenteDataUrl,
      cedulaReversoDataUrl
    };

    // Enviar a Apps Script
    const resp = await fetch(WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const out = await resp.json();

    if (!out.ok) {
      alert(out.error || out.message || "No se pudo completar el check-in.");
      return;
    }

    // Abrir el PDF
    if (out.pdf_url) {
      window.open(out.pdf_url, "_blank");
    } else {
      alert("Check-in guardado, pero no llegó pdf_url.");
    }

    alert("✅ Check-in completado.");

  } catch (err) {
    console.error(err);
    alert("Error: " + (err.message || err));
  }
});
